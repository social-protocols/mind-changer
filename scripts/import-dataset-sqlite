#!/usr/bin/env bash
# https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail
set -Eeuo pipefail
# cd to root folder
cd "$(dirname "${BASH_SOURCE[0]}")/.."

# Ensure we're in the dataset directory
cd dataset

SQLITEDB=ratings.db

rm -f "$SQLITEDB"

SQL_IMPORT=$(
	cat <<EOF
.bail on
.output /dev/null
PRAGMA foreign_keys = ON;
PRAGMA journal_mode = OFF;
PRAGMA synchronous = OFF;
PRAGMA temp_store = MEMORY;
PRAGMA cache_size=10000;
PRAGMA mmap_size = 30000000000;
.output


CREATE TABLE ratings (
    noteId INTEGER,
    raterParticipantId TEXT,
    createdAtMillis INTEGER,
    version INTEGER,
    agree INTEGER,
    disagree INTEGER,
    helpful INTEGER,
    notHelpful INTEGER,
    helpfulnessLevel TEXT,
    helpfulOther INTEGER,
    helpfulInformative INTEGER,
    helpfulClear INTEGER,
    helpfulEmpathetic INTEGER,
    helpfulGoodSources INTEGER,
    helpfulUniqueContext INTEGER,
    helpfulAddressesClaim INTEGER,
    helpfulImportantContext INTEGER,
    helpfulUnbiasedLanguage INTEGER,
    notHelpfulOther INTEGER,
    notHelpfulIncorrect INTEGER,
    notHelpfulSourcesMissingOrUnreliable INTEGER,
    notHelpfulOpinionSpeculationOrBias INTEGER,
    notHelpfulMissingKeyPoints INTEGER,
    notHelpfulOutdated INTEGER,
    notHelpfulHardToUnderstand INTEGER,
    notHelpfulArgumentativeOrBiased INTEGER,
    notHelpfulOffTopic INTEGER,
    notHelpfulSpamHarassmentOrAbuse INTEGER,
    notHelpfulIrrelevantSources INTEGER,
    notHelpfulOpinionSpeculation INTEGER,
    notHelpfulNoteNotNeeded INTEGER,
    ratedOnTweetId INTEGER
) strict;

.mode tabs
.import --skip 1 /dev/stdin ratings

SELECT 'creating indexes...';
CREATE INDEX ratings_idx_raterParticipantId ON ratings(raterParticipantId);
CREATE INDEX ratings_idx_noteId ON ratings(noteId);
CREATE INDEX ratings_idx_createdAtMillis ON ratings(createdAtMillis);


.headers off
SELECT 'optimize...';
ANALYZE;
PRAGMA optimize;
SELECT 'vacuum...';
VACUUM;
;

EOF
)

# Import data using pv to show progress
pv ratings-00001.tsv | sqlite3 "$SQLITEDB" --init <(echo "$SQL_IMPORT")

# Verify the import
echo "Verifying import..."
ls -lh "$SQLITEDB"
sqlite3 --init /dev/null "$SQLITEDB" "SELECT COUNT(*) FROM ratings;"
